{% extends "layout.html" %}

{% block content %}

<h3 class="fw-bold mb-3">Tasks</h3>

<!-- Add Task Form -->
<div class="card mb-4 shadow-sm">
    <div class="card-body d-flex">
        <form method="POST" action="/add" class="d-flex w-100 align-items-center mb-3">
    <input class="form-control me-2" name="task" placeholder="Add a new task..." required>

    <select name="category" class="form-select me-2" style="max-width: 140px;">
        <option>General</option>
        <option>Work</option>
        <option>Personal</option>
        <option>Urgent</option>
    </select>

    <input type="date" name="due_date" class="form-control me-2" style="max-width: 160px;">

    <button class="btn btn-primary">Add</button>
</form>

    </div>
</div>


<!-- Task List -->
<div class="list-group">
    {% for t in tasks %}
    <div class="list-group-item d-flex justify-content-between align-items-center task-card">

        <div class="d-flex align-items-center">
            <!-- Toggle Complete -->
            <a href="/toggle/{{ t.id }}" class="me-3 fs-4 pointer text-success">
                {% if t.completed %}
                    ✔
                {% else %}
                    ○
                {% endif %}
            </a>

            <span class="{% if t.completed %}task-completed{% endif %} fs-5">
                {{ t.text }}
            </span>
        </div>

        <div>
            <!-- Edit button (opens modal) -->
            <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#editModal{{ t.id }}">
                Edit
            </button>

            <!-- Delete -->
            <a href="/delete/{{ t.id }}" class="btn btn-sm btn-danger">Delete</a>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal{{ t.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" action="/edit/{{ t.id }}">
              <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body">
                <input name="new_text" value="{{ t.text }}" class="form-control" required>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary">Save</button>
              </div>
          </form>
        </div>
      </div>
    </div>

    <div class="d-flex flex-column">
    <span class="{% if t.completed %}task-completed{% endif %} fs-5">
        {{ t.text }}
    </span>
    {% if t.due_date %}
        <small class="text-muted">
            Due: {{ t.due_date.strftime('%b %d, %Y') }}
        </small>
    {% endif %}
</div>

<style>
.overdue { color: #dc3545; font-weight: bold; }
</style>

    <script>
var el = document.getElementById('task-list');
new Sortable(el, {
    animation: 150,
    ghostClass: 'bg-light',
    onEnd: function(evt) {
        fetch('/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                old_index: evt.oldIndex,
                new_index: evt.newIndex
            })
        });
    }
});
</script>


    {% endfor %}
</div>

{% endblock %}
